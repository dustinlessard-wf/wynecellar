<!DOCTYPE html>
<html lang="en">
<head>
<title>View</title>

  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>

  <script src="http://static.stackmob.com/js/json2-min.js"></script>
  <script src="http://static.stackmob.com/js/underscore-1.4.4-min.js"></script>
  <script src="http://static.stackmob.com/js/backbone-1.0.0-min.js"></script>
  <script src="http://static.stackmob.com/js/stackmob-js-0.9.2-min.js"></script>
  <script>
    var app = (function($) {

      StackMob.init({
        publicKey: "2117d3fe-3a6d-4997-aab8-4927d3c8cfab",
        apiVersion: 0
      });

      var Wine = StackMob.Model.extend({
        schemaName: "wine"
      });

      var Wines = StackMob.Collection.extend({
        model: Wine
      });

      var HomeView = Backbone.View.extend({
        el: 'body',
        initialize: function() {
          this.collection = this.options.collection;
          this.render();
        },

        render: function() {
          this.$el.empty();
          this.$el.append("<h1>Wine Cellar</h1>");
          this.$el.append("<a href='#add'>Add Wine</a>");

          this.listView = new ListView({
            collection: this.collection
          });
          this.$el.append(this.listView.render().el);

          return this;
        }
      });

      var ListView = Backbone.View.extend({
        tagName: 'ul',

        initialize: function() {
          this.collection = this.options.collection;
          this.template = _.template($('#listTemplate').html());
          this.collection.bind('all', this.render, this);
          this.render();
        },

        render: function() {
          var $el = this.$el,
            template = this.template;

          this.$el.empty();

          this.collection.each(function(model) {
            $el.append(template(model.toJSON()));
          });

          return this;
        }
      });

      var AddView = Backbone.View.extend({
        el: 'body',

        events: {
          "click #saveBtn": "save"
        },

        initialize: function() {
          this.template = _.template($('#addTemplate').html());
          this.collection = this.options.collection;
          this.render();
        },

        render: function() {
          this.$el.empty();
          this.$el.append(this.template());

          return this;
        },

        save: function(e) {
          var collection = this.collection;
          e.preventDefault();

          var wine = new Wine({
            winery: $('#winery').val()
          });

          wine.create({
            success: function(model) {
              collection.add(model);
            }
          });

          $('#winery').val('');

          return this;
        }
      });

      var AppRouter = Backbone.Router.extend({
        routes: {
          "": "home",
          "add": "add"
        },

        initialize: function(options) {
          this.collection = options.collection;
        },

        home: function() {
          new HomeView({
            collection: this.collection
          });
        },
        add: function() {
          new AddView({
            collection: this.collection
          });
        }
      });

      var initialize = function() {
        var wines = new Wines();
        wines.fetch({
          async: true
        });

        wineApp = new AppRouter({
          collection: wines
        });
        Backbone.history.start();
      }

      return {
        initialize: initialize
      };

    }(jQuery));

    $(document).ready(function() {
      app.initialize();
    });

  </script>

  <script type="text/template" id="listTemplate">
      <li>
          <%= winery %>
      </li>
  </script>

  <script type="text/template" id="addTemplate">
    <form>
      <fieldset>
        <legend>Wine Detail</legend>
        <label for="winery">Winery Name:</label>
        <input type="text" id="winery" name="winery" value="">

        <div>
             <a href="#" id="cancelBtn" class="btn">close</a>
             <a href="#" id="saveBtn" class="btn">save</a>
        </div>

      </fieldset>
    </form>
  </script>

</head> 
<body></body>
</html>