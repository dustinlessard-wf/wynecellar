/*
 StackMob JS SDK Version 0.9.1 
 Copyright 2012-2013 StackMob Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 */

(function(){window.StackMob=this.StackMob={DEFAULT_API_VERSION:0,DEFAULT_LOGIN_SCHEMA:"user",DEFAULT_LOGIN_FIELD:"username",DEFAULT_PASSWORD_FIELD:"password",EARTH_RADIANS_MI:3956.6,EARTH_RADIANS_KM:6367.5,FORCE_CREATE_REQUEST:"stackmob_force_create_request",ARRAY_FIELDNAME:"stackmob_array_fieldname",ARRAY_VALUES:"stackmob_array_values",CASCADE_DELETE:"stackmob_cascade_delete",HARD_DELETE:!0,SOFT_DELETE:!1,API_SERVER:"api.stackmob.com",RETRY_WAIT:1e4,RETRY_ATTEMPTS:3,REFRESH_TOKEN_KEY:"oauth2.refreshToken",POST:"POST",PUT:"PUT",DELETE:"DELETE",CONTENT_TYPE_JSON:"application/json",SECURE_ALWAYS:"ALWAYS",SECURE_MIXED:"MIXED",SECURE_NEVER:"NEVER",apiVersion:0,sdkVersion:"0.9.1",publicKey:null,Storage:{STORAGE_PREFIX:"stackmob.",persist:function(e,t){localStorage&&localStorage.setItem(this.STORAGE_PREFIX+e,t)},retrieve:function(e){return localStorage?localStorage.getItem(this.STORAGE_PREFIX+e):null},remove:function(e){localStorage&&localStorage.removeItem(this.STORAGE_PREFIX+e)}},_generateCallbacks:function(e,t){return e=e||{},e.success=function(e){t.isValidResult(e)?"function"==typeof t.yes&&t.yes(e):"function"==typeof t.no&&t.no(e)},!e.error&&"function"==typeof t.error&&(e.error=t.error),e},_containsCallbacks:function(e,t){return"object"==typeof e&&_.some(t,function(t){return"function"==typeof e[t]})},getLoggedInUser:function(e){var t=!this.isOAuth2Mode()&&this.Storage.retrieve(this.loggedInUserKey)||this.Storage.retrieve("oauth2.user");if(!e||!e.success)return this.isLoggedIn(e)&&t?t:null;this.hasValidOAuth(e)},isLoggedIn:function(e){if(!this._containsCallbacks(e,["yes","no"]))return!this.isLoggedOut()||this.hasValidOAuth(e);e=this._generateCallbacks(e,{isValidResult:function(e){return"undefined"!=typeof e},yes:e.yes,no:e.no,error:e.no}),this.hasValidOAuth(e)},isUserLoggedIn:function(e,t){if(!this._containsCallbacks(t,["yes","no"]))return e==this.getLoggedInUser(t);t=this._generateCallbacks(t,{isValidResult:function(t){return t==e},yes:t.yes,no:t.no,error:t.no}),this.hasValidOAuth(t)},isLoggedOut:function(e){if(!this._containsCallbacks(e,["yes","no"]))return!this.hasValidOAuth(e);e=this._generateCallbacks(e,{isValidResult:function(e){return"undefined"==typeof e},yes:e.yes,no:e.no,error:e.yes}),this.hasValidOAuth(e)},getBaseURL:function(){return StackMob.useRelativePathForAjax?StackMob.apiDomain?StackMob.apiDomain:window.location.hostname+(window.location.port?":"+window.location.port:"")+"/":StackMob.apiDomain?StackMob.apiDomain:StackMob.API_SERVER+"/"},throwError:function(e){throw Error(e)},urlError:function(){this.throwError('A "url" property or function must be specified')},requirePublicKey:function(){StackMob.publicKey||this.throwError("Error: This requires that you initialize StackMob with a public key.")},isOAuth2Mode:function(){return!isNaN(StackMob.publicKey&&!StackMob.privateKey)},prepareCredsForSaving:function(e,t,n,r,i,s){return r=(new Date).getTime()+1e3*this._stubbedExpireTime(r),e={"oauth2.accessToken":e,"oauth2.macKey":n,"oauth2.expires":r,"oauth2.user":i,"oauth2.userSchemaInfo":s},e[StackMob.REFRESH_TOKEN_KEY]=t,e},_stubbedExpireTime:function(e){return e},saveOAuthCredentials:function(e){var t=e["oauth2.accessToken"],n=e[StackMob.REFRESH_TOKEN_KEY];this.Storage.retrieve("oauth2.accessToken")!=t&&this.Storage.persist("oauth2.expires",e["oauth2.expires"]),this.Storage.persist("oauth2.accessToken",t),this.Storage.persist(StackMob.REFRESH_TOKEN_KEY,n),this.Storage.persist("oauth2.macKey",e["oauth2.macKey"]),this.Storage.persist("oauth2.user",e["oauth2.user"]),this.Storage.persist("oauth2.userSchemaInfo",JSON.stringify(e["oauth2.userSchemaInfo"]))},hasValidOAuth:function(e){e=e||{};if(!this.isOAuth2Mode())return e&&e.error&&e.error(),!1;var t=this.getOAuthCredentials();if(!_.all([t["oauth2.accessToken"],t["oauth2.macKey"],t&&t["oauth2.expires"]||0],_.identity))return e&&e.success&&e.success(void 0),!1;if(!StackMob.hasExpiredOAuth())return e&&e.success&&e.success(this.Storage.retrieve("oauth2.user")),this.Storage.retrieve("oauth2.user");if(!e||!e.success)return!1;var n=e.success;e.success=function(e){var t=StackMob.getOAuthCredentials();n(e[t["oauth2.userSchemaInfo"]&&t["oauth2.userSchemaInfo"].loginField?t["oauth2.userSchemaInfo"].loginField:this.loginField])},this.initiateRefreshSessionCall(e)},initiateRefreshSessionCall:function(e){StackMob.refreshSession.call(StackMob,e)},shouldSendRefreshToken:function(){return this.hasExpiredOAuth()&&this.hasRefreshToken()&&this.shouldKeepLoggedIn()},keepLoggedIn:function(e){StackMob.Storage.persist("oauth2.shouldKeepLoggedIn",!0===e)},shouldKeepLoggedIn:function(){return"true"===StackMob.Storage.retrieve("oauth2.shouldKeepLoggedIn")},hasRefreshToken:function(){var e=this.getOAuthCredentials();return e&&"undefined"!=typeof e[StackMob.REFRESH_TOKEN_KEY]&&null!=e[StackMob.REFRESH_TOKEN_KEY]},getRefreshToken:function(){return this.getOAuthCredentials()[StackMob.REFRESH_TOKEN_KEY]},hasExpiredOAuth:function(){return this.isOAuth2Mode()&&null==this.getOAuthExpireTime()||this.getOAuthExpireTime()<=(new Date).getTime()},clearOAuthCredentials:function(){StackMob.Storage.remove(StackMob.loggedInUserKey),StackMob.Storage.remove("oauth2.accessToken"),StackMob.Storage.remove(StackMob.REFRESH_TOKEN_KEY),StackMob.Storage.remove("oauth2.macKey"),StackMob.Storage.remove("oauth2.expires"),StackMob.Storage.remove("oauth2.user"),StackMob.Storage.remove("oauth2.userSchemaInfo")},getOAuthCredentials:function(){var e=StackMob.Storage.retrieve("oauth2.accessToken"),t=StackMob.Storage.retrieve("oauth2.macKey"),n=StackMob.Storage.retrieve("oauth2.expires"),r=StackMob.Storage.retrieve(StackMob.REFRESH_TOKEN_KEY),i=StackMob.Storage.retrieve("oauth2.userSchemaInfo"),s=null;try{s=JSON.parse(i)}catch(o){}return _.every([e,t,n,r,s])?(e={"oauth2.accessToken":e,"oauth2.macKey":t,"oauth2.expires":n,"oauth2.userSchemaInfo":s},e[StackMob.REFRESH_TOKEN_KEY]=r,e):{}},getOAuthExpireTime:function(){var e=this.Storage.retrieve("oauth2.expires");return e?parseInt(e):null},METHOD_MAP:{create:"POST",read:"GET",update:"PUT","delete":"DELETE",post:"POST",get:"GET",put:"PUT",addRelationship:"POST",appendAndSave:"PUT",deleteAndSave:"DELETE",login:"GET",accessToken:"POST",refreshToken:"POST",logout:"GET",forgotPassword:"POST",loginWithTempAndSetNewPassword:"GET",resetPassword:"POST",facebookAccessToken:"POST",facebookAccessTokenWithCreate:"POST",createUserWithFacebook:"POST",linkUserWithFacebook:"GET",unlinkUserFromFacebook:"DELETE",gigyaAccessToken:"POST",linkUserWithGigya:"POST",unlinkUserFromGigya:"DELETE"},getProperty:function(e,t){return!e||!e[t]?null:_.isFunction(e[t])?e[t]():e[t]},init:function(e){e=e||{},this.initStart(e),this.userSchema=e.userSchema,this.loginField=e.loginField,this.passwordField=e.passwordField,this.newPasswordField="new_password",this.publicKey=e.publicKey,this.apiVersion=e.apiVersion||this.DEFAULT_API_VERSION;if("undefined"!=typeof e.apiURL)throw Error("Error: apiURL is no longer supported.  The API URL is now automatically set for PhoneGap users.");var t=e.apiDomain;if("string"==typeof t){if(0==t.indexOf("http"))throw Error("Error: apiDomain should not specify url scheme (http/https). For example, specify api.stackmob.com instead of http://api.stackmob.com. URL Scheme is determined by the 'secure' init variable.");this.apiDomain=t.indexOf("/")==t.length-1?t:t+"/"}return t=0<window.location.hostname.indexOf(".stackmobapp.com"),this.useRelativePathForAjax="boolean"==typeof e.useRelativePathForAjax?e.useRelativePathForAjax:t,this.secure=e.secure?e.secure:0==window.location.protocol.indexOf("https:")?this.SECURE_ALWAYS:0==window.location.protocol.indexOf("http:")?this.SECURE_NEVER:this.SECURE_MIXED,this.ajax=e.ajax||this.ajax,this.initEnd(e),this},initStart:function(){},initEnd:function(){},wrapStackMobCallbacks:function(){}}}).call(this),function(){function e(e){var t=e.url.match(/(^http|^https):\/\//g)+StackMob.getBaseURL(),n=e.url.replace(RegExp(t,"g"),"/"),r=t.replace(RegExp("^http://|^https://","g"),"").replace(/\//,""),i=StackMob.Storage.retrieve("oauth2.accessToken"),s=StackMob.Storage.retrieve("oauth2.macKey");StackMob.Storage.retrieve("oauth2.expires");if(StackMob.isOAuth2Mode()&&i&&s){var e=e.type,o=r.split(":"),r=1<o.length?o[0]:r,u=1<o.length?o[1]:"https"==t.substring(0,5)?443:80,t=Math.round((new Date).getTime()/1e3),o="n"+Math.round(1e4*Math.random()),n=CryptoJS.HmacSHA1(t+"\n"+o+"\n"+e+"\n"+n+"\n"+r+"\n"+u+"\n\n",s).toString(CryptoJS.enc.Base64);return'MAC id="'+i+'",ts="'+t+'",nonce="'+o+'",mac="'+n+'"'}}function t(e,t){var t=t||{},n;if(!0===t.secureRequest)n="https";else switch(StackMob.secure){case StackMob.SECURE_ALWAYS:n="https";break;case StackMob.SECURE_NEVER:n="http";break;default:n=StackMob._isSecureMethod(e,t)?"https":"http"}return n+"://"}var n=this;_.extend(StackMob,{isSencha:function(){return n.Ext},isZepto:function(){return n.Zepto},initEnd:function(){StackMob.Model=Backbone.Model.extend({urlRoot:StackMob.getBaseURL(),getBinaryFields:function(){return this.binaryFields||[]},url:function(){var e=StackMob.getBaseURL();return e+=this.schemaName},getPrimaryKeyField:function(){return this.schemaName+"_id"},constructor:function(){this.setIDAttribute(),Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){StackMob.getProperty(this,"schemaName")||StackMob.throwError("A schemaName must be defined"),this.setIDAttribute()},setIDAttribute:function(){this.idAttribute=this.getPrimaryKeyField()},parse:function(e){return!e||e&&(!e.text||""==e.text)?e:JSON.parse(e.text)},sync:function(e,t,n){StackMob.sync.call(this,e,this,n)},create:function(e){var t={};t[StackMob.FORCE_CREATE_REQUEST]=!0,_.extend(t,e),this.save(null,t)},query:function(e,t){t=t||{},_.extend(t,{query:e}),this.fetch(t)},fetch:function(e){StackMob.wrapStackMobCallbacks.call(this,e),Backbone.Model.prototype.fetch.call(this,e)},destroy:function(e){StackMob.wrapStackMobCallbacks.call(this,e),Backbone.Model.prototype.destroy.call(this,e)},save:function(e,t){var n=e?e.success:{},r=e?e.error:{};"undefined"==typeof t&&(_.isFunction(n)||_.isFunction(r))?(StackMob.wrapStackMobCallbacks.call(this,e),Backbone.Model.prototype.save.call(this,null,e)):(StackMob.wrapStackMobCallbacks.call(this,t),Backbone.Model.prototype.save.call(this,e,t))},fetchExpanded:function(e,t){(0>e||3<e)&&StackMob.throwError("Depth must be between 0 and 3 inclusive.");var n={};_.extend(n,t),n.data=n.data||{},n.data._expand=e,this.fetch(n)},getAsModel:function(e,t){var n=this.get(e);return n?_.isArray(n)?_.map(n,function(e){return new t(e)}):new t(n):{}},appendAndCreate:function(e,t,n){this.addRelationship(e,t,n)},addRelationship:function(e,t,n){n=n||{},n[StackMob.ARRAY_FIELDNAME]=e,n[StackMob.ARRAY_VALUES]=t,StackMob.sync.call(this,"addRelationship",this,n)},appendAndSave:function(e,t,n){n=n||{},n[StackMob.ARRAY_FIELDNAME]=e,n[StackMob.ARRAY_VALUES]=t,StackMob.sync.call(this,"appendAndSave",this,n)},deleteAndSave:function(e,t,n,r){r=r||{},r[StackMob.ARRAY_FIELDNAME]=e,r[StackMob.ARRAY_VALUES]=t,r[StackMob.CASCADE_DELETE]=n;var i=this;r.stackmob_ondeleteAndSave=function(){var n=i.get(e);i.set(e,_.difference(n,t))},StackMob.sync.call(this,"deleteAndSave",this,r)},setBinaryFile:function(e,t,n,r){this.set(e,"Content-Type: "+n+"\nContent-Disposition: attachment; filename="+t+"\nContent-Transfer-Encoding: base64\n\n"+r)},incrementOnSave:function(e,t){this.attributes[this.idAttribute]?(this.attributes[e]&&delete this.attributes[e],this.set(e+"[inc]",t)):StackMob.throwError("Please specify an id for the row you wish to update. When creating a new instance of your object, you need to pass in JSON that includes the id field and value (e.g. var user = new StackMob.User({ username: 'chucknorris' });)  Or, for custom objects: var todoInstance = new Todo({todo_id : '1234'})")},decrementOnSave:function(e,t){this.incrementOnSave(e,-1*t)}}),StackMob.Collection=Backbone.Collection.extend({initialize:function(){this.model||StackMob.throwError("Please specify a StackMob.Model for this collection. e.g., var Items = StackMob.Collection.extend({ model: Item });"),this.schemaName=(new this.model).schemaName},url:function(){var e=StackMob.getBaseURL();return e+=this.schemaName},parse:function(e){return!e||e&&(!e.text||""==e.text)?e:JSON.parse(e.text)},sync:function(e,t,n){StackMob.sync.call(this,e,this,n)},query:function(e,t){t=t||{},_.extend(t,{query:e}),this.fetch(t)},destroyAll:function(e,t){var t=t||{},n=this,r=t.success;return t.success=function(e){n.remove(n.models),"function"==typeof r&&r(e)},_.extend(t,{query:e}),(this.sync||Backbone.sync).call(this,"delete",this,t)},create:function(e,t){var n={};n[StackMob.FORCE_CREATE_REQUEST]=!0,_.extend(n,t),StackMob.wrapStackMobCallbacks.call(this,n),Backbone.Collection.prototype.create.call(this,e,n)},fetch:function(e){StackMob.wrapStackMobCallbacks.call(this,e),Backbone.Collection.prototype.fetch.call(this,e)},createAll:function(e){return e=e||{},(this.sync||Backbone.sync).call(this,"create",this,e)},count:function(e,t){e=e||new StackMob.Collection.Query,t=t||{},t.stackmob_count=!0;var n=t.success;return t.success=function(e){if(e&&e.getAllResponseHeaders){var t=e.getResponseHeader("Content-Range"),r=0;t&&(r=t.substring(t.indexOf("/")+1,t.length));if(0===r)try{r=JSON.parse(e.responseText).length}catch(i){}n&&n(r)}else n(e)},e.setRange&&(t.query=e.setRange(0,0)),(this.sync||Backbone.sync).call(this,"query",this,t)}}),r()},cc:function(e,t,n,r){this.customcode(e,t,n,r)},customcode:function(e,n,r,i){_.isObject(r)?(i=r||{},r=(r=i.httpVerb)&&!_.isUndefined(StackMob.METHOD_MAP[r.toLowerCase()])?r:"GET",i.httpVerb=r):(i=i||{},_.isString(r)&&r&&!_.isUndefined(StackMob.METHOD_MAP[r.toLowerCase()])&&(i.httpVerb=r.toUpperCase())),i.data=i.data||{},"GET"!==r&&(i.contentType=i.contentType||StackMob.CONTENT_TYPE_JSON),_.extend(i.data,n),i.url=t(e,n)+this.getBaseURL(),this.sync.call(StackMob,e,null,i)},processLogin:function(e,t){if(StackMob.isOAuth2Mode()){var n=e.access_token,r=e.refresh_token,i=e.mac_key,s=e.expires_in;try{var o=StackMob.getOAuthCredentials(),u=t.stackmob_userschemainfo||o["oauth2.userSchemaInfo"],a=e.stackmob.user[u.loginField],f=StackMob.prepareCredsForSaving(n,r,i,s,a,u);StackMob.saveOAuthCredentials(f),StackMob.Storage.persist(StackMob.loggedInUserKey,a)}catch(l){console&&console.error("Problem saving OAuth 2.0 credentials and user: "+l)}}},sync:function(n,r,i){i=i||{};if(!StackMob.isAccessTokenMethod(n)&&StackMob.shouldSendRefreshToken()&&!0!==i.stackmob_attempted_refresh){var s=n,o=i;o.stackmob_attempted_refresh=!0;var u=this;return StackMob.refreshSession.call(StackMob,{oncomplete:function(){StackMob.sync.call(u,s,r,o)}}),!1}var a=!0===i[StackMob.FORCE_CREATE_REQUEST];a&&(n="create");var l=_.extend({type:i.httpVerb||StackMob.METHOD_MAP[n]||"GET",dataType:"json"},i);l.data=l.data||{};var h=n,p;p=l||{};var d=t(h,p);!p.url&&r&&(p.url=d+r.url());var d="cc"!=h,v=r&&r.isNew&&!r.isNew(),a=!a,m="addRelationship"==h||"appendAndSave"==h||"deleteAndSave"==h;if(_.include("create update delete read query deleteAndSave appendAndSave addRelationship".split(" "),h)){if(m||d&&v&&a)p.url+=("/"==p.url.charAt(p.url.length-1)?"":"/")+encodeURIComponent(r.get(r.getPrimaryKeyField())),m&&(p.url+="/"+i[StackMob.ARRAY_FIELDNAME]),"deleteAndSave"==h&&(h="",h=_.isArray(i[StackMob.ARRAY_VALUES])?_.map(i[StackMob.ARRAY_VALUES],function(e){return encodeURIComponent(e)}).join(","):encodeURIComponent(i[StackMob.ARRAY_VALUES]),p.url+="/"+h)}else p.url+=("/"==p.url.charAt(p.url.length-1)?"":"/")+h;p=n,h=i||{},l.headers=l.headers||{},l.headers=_.extend({Accept:"application/vnd.stackmob+json; version="+StackMob.apiVersion},l.headers),_.extend(l.headers,{"X-StackMob-User-Agent":"StackMob (JS; "+StackMob.sdkVersion+")"}),StackMob.publicKey&&!StackMob.privateKey?(l.headers["X-StackMob-API-Key"]=StackMob.publicKey,l.headers["X-StackMob-Proxy-Plain"]="stackmob-api",l.headers["X-StackMob-API-Key-"+StackMob.publicKey]="1"):l.headers["X-StackMob-Proxy"]="stackmob-api",StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(p)?l.contentType="application/x-www-form-urlencoded":_.include(["PUT","POST"],StackMob.METHOD_MAP[p])&&(l.contentType=l.contentType||StackMob.CONTENT_TYPE_JSON),isNaN(h[StackMob.CASCADE_DELETE])||(l.headers["X-StackMob-CascadeDelete"]=1==h[StackMob.CASCADE_DELETE]);if(h.query&&(p=l.query||throwError("No StackMobQuery object provided to the query call."),p.selectFields&&0<p.selectFields.length&&(l.headers["X-StackMob-Select"]=p.selectFields.join()),p.range&&(l.headers.Range="objects="+p.range.start+"-"+p.range.end),_.extend(l.data,p.params),p.orderBy&&0<p.orderBy.length)){p=p.orderBy,h="",d=p.length;for(v=0;v<d;v++)h+=p[v],v+1<d&&(h+=",");l.headers["X-StackMob-OrderBy"]=h}p=n,d=function(e){return _.map(_.keys(e),function(t){return t+"="+encodeURIComponent(e[t])}).join("&")},h=i||{};if(StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(p))l.data=d(l.data);else if("POST"==l.type||"PUT"==l.type)if("resetPassword"==p||"forgotPassword"==p)l.data=JSON.stringify(l.data);else if("addRelationship"==p||"appendAndSave"==p)h&&h[StackMob.ARRAY_VALUES]&&(l.data=JSON.stringify(h[StackMob.ARRAY_VALUES]));else if(r){var g=r.toJSON();_.each(h.remote_ignore||[],function(e){delete g[e]}),delete g.lastmoddate,delete g.createddate,"update"==p&&((p=h.stackmob_userschemainfo||StackMob.getOAuthCredentials()["oauth2.userSchemaInfo"])&&delete g[p.passwordField],_.each(r.getBinaryFields(),function(e){g[e]&&0==g[e].indexOf("http")&&delete g[e]})),StackMob.isOAuth2Mode()&&delete g.sm_owner,l.data=JSON.stringify(_.extend(g,l.data))}else l.data=JSON.stringify(l.data);else("GET"==l.type||"DELETE"==l.type)&&!_.isEmpty(l.data)&&(l.url+="?",p=d(l.data),l.url+=p),delete l.data;p=l||{},p.processData=!1,p.accepts=p.headers.Accept,StackMob.isAccessTokenMethod(n)||(p=e(l))&&(l.headers.Authorization=p),StackMob.makeAPICall(r,l,n,i)},refreshSession:function(e){var n={};_.extend(n,e);if(StackMob.hasRefreshToken()){var r=StackMob.getOAuthCredentials()["oauth2.userSchemaInfo"]?StackMob.getOAuthCredentials()["oauth2.userSchemaInfo"].schemaName:StackMob.userSchema;n.url=t("refreshToken")+this.getBaseURL()+r,n.contentType="application/x-www-form-urlencoded",n.data={refresh_token:StackMob.getOAuthCredentials()[StackMob.REFRESH_TOKEN_KEY],grant_type:"refresh_token",token_type:"mac",mac_algorithm:"hmac-sha1"};var i=e.oncomplete;i&&(n.oncomplete=function(){i()}),e&&e.success&&(n.success=e.success),n.stackmob_onrefreshToken=StackMob.processLogin,n.error=function(){e&&e.error&&e.error(),StackMob.Storage.remove(StackMob.REFRESH_TOKEN_KEY)},(this.sync||Backbone.sync).call(this,"refreshToken",this,n)}else e&&e.error&&e.error()},makeAPICall:function(e,t,n,r){return StackMob.ajax?StackMob.ajax(e,t,n,r):StackMob.isSencha()?StackMob.ajaxOptions.sencha(e,t,n,r):StackMob.isZepto()?StackMob.ajaxOptions.zepto(e,t,n,r):StackMob.ajaxOptions.jquery(e,t,n,r)},onsuccess:function(e,t,n,r,i,s){n&&(_.isFunction(n["stackmob_on"+t])&&n["stackmob_on"+t](r,s),_.isFunction(n.oncomplete)&&n.oncomplete(r));if(i)if(r)if(StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(t)&&r.stackmob){r=r.stackmob.user,t=!0===s.fullyPopulateUser;if(e&&e.parse)if(t){if(!e.set(e.parse(r,s),s))return!1}else if(n={},n[e.getPrimaryKeyField()]=r[e.getPrimaryKeyField()],!e.set(n,s))return!1;i(r),t&&e&&e.trigger&&e.trigger("sync",e,r,s)}else i(r);else i()},onerror:function(t,n,r,i,s,o){var i=t.status,u;try{u=JSON.parse(n)}catch(a){u={error:"Invalid JSON returned."}}if(503==i){t=t.getResponseHeader("retry-after");try{t=1e3*parseInt(responseHeaderValue)}catch(f){t=StackMob.RETRY_WAIT}if("number"==typeof s.stackmob_retry){if(s.stackmob_retry-=1,0>=s.stackmob_retry)return}else s.stackmob_retry=StackMob.RETRY_ATTEMPTS;_.delay(function(){var t=e(s);s.headers.Authorization=t,r&&r(s)},t)}else _.isFunction(s.oncomplete)&&s.oncomplete(u),o&&o(u)},isAccessTokenMethod:function(e){return _.include(["accessToken","refreshToken","facebookAccessToken","facebookAccessTokenWithCreate","gigyaAccessToken"],e)},_isSecureMethod:function(e,t){var n="loginWithTempAndSetNewPassword createUserWithFacebook linkUserWithFacebook unlinkUserFromFacebook linkUserWithGigya unlinkUserFromGigya".split(" ");return StackMob.isAccessTokenMethod(e)?!0:1==t.isUserCreate?!0:_.include(n,e)}});var r=function(){StackMob.User=StackMob.Model.extend({schemaName:StackMob.userSchema||StackMob.DEFAULT_LOGIN_SCHEMA,loginField:StackMob.loginField||StackMob.DEFAULT_LOGIN_FIELD,passwordField:StackMob.passwordField||StackMob.DEFAULT_PASSWORD_FIELD,idAttribute:this.loginField,getPrimaryKeyField:function(){return this.loginField},create:function(e){e=e||{},e.isUserCreate=!0,StackMob.Model.prototype.create.call(this,e)},isLoggedIn:function(e){e=e||{};if(!StackMob._containsCallbacks(e,["yes","no"]))return StackMob.isUserLoggedIn(this.get(this.loginField),e);e=StackMob._generateCallbacks(e,{isValidResult:function(e){return"undefined"!=typeof e},yes:e.yes,no:e.no,error:e.no}),StackMob.hasValidOAuth(e)},login:function(e,t){t=t||{},StackMob.keepLoggedIn("undefined"==typeof e?!1:e),t.data=t.data||{},t.data[this.loginField]=this.get(this.loginField),t.data[this.passwordField]=this.get(this.passwordField),StackMob.isOAuth2Mode()&&(t.data.token_type="mac"),t.stackmob_onaccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,StackMob.isOAuth2Mode()?"accessToken":"login",this,t)},logout:function(e){e=e||{},e.data=e.data||{},(this.sync||Backbone.sync).call(this,"logout",this,e),StackMob.clearOAuthCredentials()},loginWithGigya:function(e,t,n,r,i){i=i||{},StackMob.keepLoggedIn("undefined"==typeof r?!1:r),i.data=i.data||{},_.extend(i.data,{gigya_uid:e,gigya_ts:t,gigya_sig:n,token_type:"mac"}),i.stackmob_ongigyaAccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,"gigyaAccessToken",this,i)},linkUserWithGigya:function(e,t,n,r){r=r||{},r.data=r.data||{},_.extend(r.data,{gigya_uid:e,gigya_ts:t,gigya_sig:n,token_type:"mac"}),(this.sync||Backbone.sync).call(this,"linkUserWithGigya",this,r)},unlinkUserFromGigya:function(e){(this.sync||Backbone.sync).call(this,"unlinkUserFromGigya",this,e)},loginWithFacebook:function(e,t,n){this.loginWithFacebookToken(e,t,n)},loginWithFacebookToken:function(e,t,n){n=n||{},StackMob.keepLoggedIn("undefined"==typeof t?!1:t),n.data=n.data||{},_.extend(n.data,{fb_at:e,token_type:"mac"}),!0===n.createIfNeeded?(n.stackmob_onfacebookAccessTokenWithCreate=StackMob.processLogin,n.data[this.loginField]=n[this.loginField]||this.get(this.loginField),(this.sync||Backbone.sync).call(this,"facebookAccessTokenWithCreate",this,n)):(n.stackmob_onfacebookAccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,"facebookAccessToken",this,n))},loginWithFacebookAutoCreate:function(e,t,n){n=n||{},n.createIfNeeded=!0,this.loginWithFacebookToken(e,t,n)},createUserWithFacebook:function(e,t){t=t||{},t.data=t.data||{},_.extend(t.data,{fb_at:e,token_type:"mac"}),t.data[this.loginField]=t[this.loginField]||this.get(this.loginField),(this.sync||Backbone.sync).call(this,"createUserWithFacebook",this,t)},linkUserWithFacebook:function(e,t){t=t||{},t.data=t.data||{},_.extend(t.data,{fb_at:e,token_type:"mac"}),(this.sync||Backbone.sync).call(this,"linkUserWithFacebook",this,t)},unlinkUserFromFacebook:function(e){(this.sync||Backbone.sync).call(this,"unlinkUserFromFacebook",this,e)},loginWithTempAndSetNewPassword:function(e,t,n,r){r=r||{},r.data=r.data||{},this.set(this.passwordField,e),r.data[StackMob.newPasswordField]=t,this.login(n,r)},forgotPassword:function(e){e=e||{},e.data=e.data||{},e.data[this.loginField]=this.get(this.loginField),(this.sync||Backbone.sync).call(this,"forgotPassword",this,e)},resetPassword:function(e,t,n){n=n||{},n.data=n.data||{},n.data.old={password:e},n.data["new"]={password:t},(this.sync||Backbone.sync).call(this,"resetPassword",this,n)},sync:function(e,t,n){n=n||{},n.stackmob_userschemainfo={schemaName:this.schemaName,loginField:this.loginField,passwordField:this.passwordField},StackMob.Model.prototype.sync.call(this,e,t,n)}}),StackMob.Users=StackMob.Collection.extend({model:StackMob.User}),StackMob.GeoPoint=function(e,t){_.isNumber(e)?((-90>e||90<e)&&StackMob.throwError("Latitude value must be between -90 and 90 inclusive."),(-180>t||180<t)&&StackMob.throwError("Longitude value must be between -180 and 180 inclusive."),this.lat=e,this.lon=t):((-90>e.lat||90<e.lat)&&StackMob.throwError("Latitude value must be between -90 and 90 inclusive."),(-180>e.lon||180<e.lon)&&StackMob.throwError("Longitude value must be between -180 and 180 inclusive."),this.lat=e.lat,this.lon=e.lon)},StackMob.GeoPoint.prototype.toJSON=function(){return{lat:this.lat,lon:this.lon}},StackMob.Model.Query=function(){this.selectFields=[],this.params={}},_.extend(StackMob.Model.Query.prototype,{select:function(e){return this.selectFields.push(e),this},setExpand:function(e){return this.params._expand=e,this}}),StackMob.Collection.Query=function(){this.params={},this.selectFields=[],this.orderBy=[],this.range=null},StackMob.Collection.Query.prototype=new StackMob.Model.Query,StackMob.Collection.Query.prototype.constructor=StackMob.Collection.Query,_.extend(StackMob.Collection.Query.prototype,{or:function(e){if("undefined"==typeof this.orId){var t=this.clone();t.params={},t.orId=1,t.andCount=1;var n,r;r=_.keys(this.params),n="",1<r.length&&(n=t.andCount++,n="[and"+n+"].");for(key in this.params)r="[or"+t.orId+"]."+n+key,t.params[r]=this.params[key]}else t=this.clone();r=_.keys(e.params),n="",1<r.length&&(n=t.andCount++,n="[and"+n+"].");for(key in e.params){r="[or"+t.orId+"]."+n+key;if("undefined"!=typeof t.params[r])throw Error("Error: You are attempting to OR two or more values for the same field. You should use an mustBeOneOf method instead.");t.params[r]=e.params[key]}return t},and:function(e){var t=this.clone(),n;for(n in e.params)t.params[n]=e.params[n];return t},clone:function(){var e=_.clone(this);return e.params=_.clone(this.params),e},addParam:function(e,t){return this.params[e]=t,this},equals:function(e,t){return""===t?this.params[e+"[empty]"]=!0:this.params[e]=t,this},lt:function(e,t){return this.params[e+"[lt]"]=t,this},lte:function(e,t){return this.params[e+"[lte]"]=t,this},gt:function(e,t){return this.params[e+"[gt]"]=t,this},gte:function(e,t){return this.params[e+"[gte]"]=t,this},notEquals:function(e,t){return""===t?this.params[e+"[empty]"]=!1:this.params[e+"[ne]"]=t,this},isNull:function(e){return this.params[e+"[null]"]=!0,this},isNotNull:function(e){return this.params[e+"[null]"]=!1,this},mustBeOneOf:function(e,t){var n="";if(_.isArray(t))for(var r=t.length,i=0;i<r;i++)n+=t[i],i+1<r&&(n+=",");else n=t;return this.params[e+"[in]"]=n,this},orderAsc:function(e){return this.orderBy.push(e+":asc"),this},orderDesc:function(e){return this.orderBy.push(e+":desc"),this},setRange:function(e,t){return this.range={start:e,end:t},this},mustBeNear:function(e,t,n){return this.params[e+"[near]"]=t.lat+","+t.lon+","+n,this},mustBeNearMi:function(e,t,n){return this.mustBeNear(e,t,n/StackMob.EARTH_RADIANS_MI),this},mustBeNearKm:function(e,t,n){return this.mustBeNear(e,t,n/StackMob.EARTH_RADIANS_KM),this},isWithin:function(e,t,n){return this.params[e+"[within]"]=t.lat+","+t.lon+","+n,this},isWithinMi:function(e,t,n){return this.isWithin(e,t,n/StackMob.EARTH_RADIANS_MI),this},isWithinKm:function(e,t,n){return this.isWithin(e,t,n/StackMob.EARTH_RADIANS_KM),this},isWithinBox:function(e,t,n){return this.params[e+"[within]"]=t.lat+","+t.lon+","+n.lat+","+n.lon,this}})}}.call(this),function(){var e=this.jQuery||this.Ext||this.Zepto;_.extend(StackMob,{ajaxOptions:{sencha:function(t,n,r,i){var s={},o=n.success;n.success=function(e){var s=e&&e.responseText?JSON.parse(e.responseText):null;!0===n.stackmob_count&&(s=e),StackMob.onsuccess(t,r,n,s,o,i)};var u=n.error;return s.url=n.url,s.headers=n.headers,s.params=n.data,s.success=n.success,s.disableCaching=!1,s.method=n.type,n.error=function(n,r){StackMob.onerror(n,n.responseText||n.text,e.Ajax.request,t,s,u,r)},s.failure=n.error,e.Ajax.request(s)},zepto:function(t,n,r,i){var s=n.success,o=function(e,o){o=e?JSON.parse(e):null,StackMob.onsuccess(t,r,n,o,s,i)};n.success=o;var u=n.error,a=function(r){StackMob.onerror(r,r.responseText||r.text,e.ajax,t,n,u,i)};n.error=a;var f={};return f.url=n.url,f.headers=n.headers,f.contentType=n.headers.contentType,f.type=n.type,f.data=n.data,f.success=o,f.error=a,e.ajax(f)},jquery:function(t,n,r,i){n.beforeSend=function(e,t){e.setRequestHeader("Accept",t.accepts);if(!_.isEmpty(t.headers))for(key in t.headers)e.setRequestHeader(key,t.headers[key])};var s=n.error;n.error=function(r,o,u){0==r.status&&n.query&&"object"==typeof n.query.range?this.success(r,o,u):StackMob.onerror(r,r.responseText||r.text,e.ajax,t,n,s,i)};var o=n.success;return n.success=function(e,s,u){var l;!0===n.stackmob_count?l=u:e&&e.toJSON?l=e:e&&(e.responseText||e.text)?l=JSON.parse(e.responseText||e.text):e&&(l=e),StackMob.onsuccess(t,r,n,l,o,i)},e.ajax(n)}}})}.call(this);var CryptoJS=CryptoJS||function(e,t){var n={},r=n.lib={},i=function(){},s=r.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.$super.extend(this)}},o=r.WordArray=s.extend({init:function(e,n){e=this.words=e||[],this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,e=e.sigBytes;this.clamp();if(r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-8*(i%4)&255)<<24-8*((r+i)%4);else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4),t.length=e.ceil(n/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return o.create(n,t)}}),u=n.enc={},a=u.Hex={stringify:function(e){for(var t=e.words,e=e.sigBytes,n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-8*(r%4)&255;n.push((i>>>4).toString(16)),n.push((i&15).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-4*(r%8);return o.create(n,t/2)}},f=u.Latin1={stringify:function(e){for(var t=e.words,e=e.sigBytes,n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-8*(r%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(e.charCodeAt(r)&255)<<24-8*(r%4);return o.create(n,t)}},l=u.Utf8={stringify:function(e){try{return decodeURIComponent(escape(f.stringify(e)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(e){return f.parse(unescape(encodeURIComponent(e)))}},c=r.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=o.create(),this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,s=this.blockSize,u=i/(4*s),u=t?e.ceil(u):e.max((u|0)-this._minBufferSize,0),t=u*s,i=e.min(4*t,i);if(t){for(var a=0;a<t;a+=s)this._doProcessBlock(r,a);a=r.splice(0,t),n.sigBytes-=i}return o.create(a,i)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=c.extend({init:function(){this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize(),this._hash},clone:function(){var e=c.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:16,_createHelper:function(e){return function(t,n){return e.create(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return h.HMAC.create(e,n).finalize(t)}}});var h=n.algo={};return n}(Math);(function(){var e=CryptoJS,t=e.lib,n=t.WordArray,t=t.Hasher,r=[],i=e.algo.SHA1=t.extend({_doReset:function(){this._hash=n.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=0;80>f;f++){if(16>f)r[f]=e[t+f]|0;else{var l=r[f-3]^r[f-8]^r[f-14]^r[f-16];r[f]=l<<1|l>>>31}l=(i<<5|i>>>27)+a+r[f],l=20>f?l+((s&o|~s&u)+1518500249):40>f?l+((s^o^u)+1859775393):60>f?l+((s&o|s&u|o&u)-1894007588):l+((s^o^u)-899497514),a=u,u=o,o=s<<30|s>>>2,s=i,i=l}n[0]=n[0]+i|0,n[1]=n[1]+s|0,n[2]=n[2]+o|0,n[3]=n[3]+u|0,n[4]=n[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;t[r>>>5]|=128<<24-r%32,t[(r+64>>>9<<4)+15]=n,e.sigBytes=4*t.length,this._process()}});e.SHA1=t._createHelper(i),e.HmacSHA1=t._createHmacHelper(i)})(),function(){var e=CryptoJS,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=e.create(),"string"==typeof n&&(n=t.parse(n));var r=e.blockSize,i=4*r;n.sigBytes>i&&(n=e.finalize(n));for(var s=this._oKey=n.clone(),o=this._iKey=n.clone(),u=s.words,a=o.words,l=0;l<r;l++)u[l]^=1549556828,a[l]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,e=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e=CryptoJS,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp();for(var e=[],i=0;i<n;i+=3)for(var s=(t[i>>>2]>>>24-8*(i%4)&255)<<16|(t[i+1>>>2]>>>24-8*((i+1)%4)&255)<<8|t[i+2>>>2]>>>24-8*((i+2)%4)&255,o=0;4>o&&i+.75*o<n;o++)e.push(r.charAt(s>>>6*(3-o)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var e=e.replace(/\s/g,""),n=e.length,r=this._map,i=r.charAt(64);i&&(i=e.indexOf(i),-1!=i&&(n=i));for(var i=[],s=0,o=0;o<n;o++)if(o%4){var u=r.indexOf(e.charAt(o-1))<<2*(o%4),a=r.indexOf(e.charAt(o))>>>6-2*(o%4);i[s>>>2]|=(u|a)<<24-8*(s%4),s++}return t.create(i,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();